<!DOCTYPE html>
<html lang="zh-Hans-CN">
  <head>
    <meta charset="utf-8">
    <meta id="keywords" name="keywords">
    <meta id="description" name="description">
    <title>活动详情 - 摆渡星空</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#232323">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" sizes="192x192" href="/webrexco/static/img/ideal/icon.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/webrexco/static/img/ideal/icon-120.png">
    <link rel="stylesheet" href="/webrexco/static/css/cmn/common.css">
    <link rel="stylesheet" href="/webrexco/static/css/space/common.css">
    <link rel="stylesheet" href="/webrexco/static/css/ideal/swiper.min.css">
    <link rel="stylesheet" href="/webrexco/static/css/events/events.css">
  </head>
  <body>
     
    <% include ../cmn/header.ejs %>
    <div class="content">
      <div class="main"></div>
      <div class="side">
        <div class="header border">活动地点</div>
        <div id="map"></div>
        <div class="line"></div>
        <div class="header">报名记录</div>
        <div class="list">
          <!-- Slider main container-->
          <div class="swiper-container swiper-container-vertical">
            <!-- Additional required wrapper-->
            <div class="swiper-wrapper"></div>
          </div>
        </div>
      </div>
      <div class="mask">
        <div class="popup">
          <div class="title">活动报名</div>
          <div class="close"></div>
          <form>
            <input id="input-activity-id" type="hidden" name="activityId">
            <div class="input">
              <label class="label" for="input-name">姓名</label>
              <input id="input-name" type="text" data-name="姓名" placeholder="必填" name="name" required>
              <input class="checkbox" id="input-anonymous" type="checkbox" name="isAnonymous" value="true">
              <label for="input-anonymous">匿名</label>
            </div>
            <div class="input">
              <label class="label" for="input-company">公司名称</label>
              <input id="input-company" type="text" data-name="公司名称" placeholder="必填" name="companyName" required>
            </div>
            <div class="input">
              <label class="label" for="input-position">职位</label>
              <input id="input-position" type="text" data-name="职位" name="job">
            </div>
            <div class="input">
              <label class="label" for="input-phone">手机号</label>
              <input id="input-phone" type="text" inputmode="tel" pattern="1[34578]\d{9}" maxlength="11" data-name="您的手机号码" placeholder="必填" name="phone" required>
            </div>
            <div class="input">
              <label class="label" for="input-mail">邮箱</label>
              <input id="input-mail" type="text" data-name="邮箱" name="email">
            </div>
            <div class="input">
              <label class="label" for="input-weixin">微信号</label>
              <input id="input-weixin" type="text" data-name="微信号" name="weixinNum">
            </div>
          </form>
          <div class="buttons">
            <div class="button" id="submit">提交报名</div>
          </div>
        </div>
      </div>
      <div class="g-fixedIcon">
        <div class="u-toBodyTop"></div>
      </div>
    </div>
     
    <% include ../cmn/footer.ejs %>
    <script src="/webrexco/static/js/cmn/rexco-0.1.min.js"></script>
    <script src="/webrexco/static/js/header.js"></script>
    <script src="/webrexco/static/js/cmn/jquery.placeholder.js"></script>
    <script src="/webrexco/static/js/cmn/jquery-qrcode.min.js"></script>
    <script src="/webrexco/static/js/ideal/swiper.jquery.js"></script>
    <script src="/webrexco/activity/login/show.js"></script>
    <script>function pug_attr(t,e,n,f){return e!==!1&&null!=e&&(e||"class"!==t&&"style"!==t)?e===!0?" "+(f?t:t+'="'+t+'"'):("function"==typeof e.toJSON&&(e=e.toJSON()),"string"==typeof e||(e=JSON.stringify(e),n||e.indexOf('"')===-1)?(n&&(e=pug_escape(e))," "+t+'="'+e+'"'):" "+t+"='"+e.replace(/'/g,"&#39;")+"'"):""}
function pug_escape(e){var a=""+e,t=pug_match_html.exec(a);if(!t)return e;var r,c,n,s="";for(r=t.index,c=0;r<a.length;r++){switch(a.charCodeAt(r)){case 34:n="&quot;";break;case 38:n="&amp;";break;case 60:n="&lt;";break;case 62:n="&gt;";break;default:continue}c!==r&&(s+=a.substring(c,r)),c=r+1,s+=n}return c!==r?s+a.substring(c,r):s}
var pug_has_own_property=Object.prototype.hasOwnProperty;
var pug_match_html=/["&<>]/;
function pug_style(r){if(!r)return"";if("object"==typeof r){var t="";for(var e in r)pug_has_own_property.call(r,e)&&(t=t+e+":"+r[e]+";");return t}return r+="",";"!==r[r.length-1]?r+";":r}function detail(locals) {var pug_html = "", pug_mixins = {}, pug_interp;;var locals_for_with = (locals || {});(function (address, detail, encodeURIComponent, endTime, host, link, people, poster, share, signed, startTime, status, title) {var imageCss = "url(" + poster + ")"
var imageFilter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(src='" + poster + "', sizingMethod='scale');"
pug_html = pug_html + "\u003Cdiv" + (" class=\"image\""+pug_attr("style", pug_style("background-image: " + imageCss + "; filter: " + imageFilter), true, false)) + "\u003E\u003C\u002Fdiv\u003E\u003Cdiv class=\"info\"\u003E\u003Cdiv id=\"title\"\u003E" + (pug_escape(null == (pug_interp = title) ? "" : pug_interp)) + "\u003C\u002Fdiv\u003E\u003Cdiv\u003E\u003Cdiv class=\"i-clock\"\u003E\u003C\u002Fdiv\u003E\u003Cspan\u003E" + (pug_escape(null == (pug_interp = startTime + " - " + endTime) ? "" : pug_interp)) + "\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E\u003Cdiv\u003E\u003Cdiv class=\"i-address\"\u003E\u003C\u002Fdiv\u003E\u003Cspan\u003E" + (pug_escape(null == (pug_interp = address) ? "" : pug_interp)) + "\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E\u003Cdiv\u003E\u003Cdiv class=\"i-people\"\u003E\u003C\u002Fdiv\u003E\u003Cspan\u003E" + (pug_escape(null == (pug_interp = people) ? "" : pug_interp)) + "\u003C\u002Fspan\u003E\u003Cdiv class=\"i-host\"\u003E\u003C\u002Fdiv\u003E\u003Cspan\u003E" + (pug_escape(null == (pug_interp = host) ? "" : pug_interp)) + "\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E\u003Cdiv\u003E";
switch (status){
case 0:
pug_html = pug_html + "\u003Cdiv class=\"button red disable\"\u003E审核中\u003C\u002Fdiv\u003E";
  break;
case 1:
if (signed) {
pug_html = pug_html + "\u003Cdiv class=\"button red disable\"\u003E已报名\u003C\u002Fdiv\u003E";
}
else {
pug_html = pug_html + "\u003Cdiv class=\"button red\" id=\"sign\"\u003E我要报名\u003C\u002Fdiv\u003E";
}
  break;
case 3:
if (signed) {
pug_html = pug_html + "\u003Cdiv class=\"button red disable\"\u003E已报名\u003C\u002Fdiv\u003E";
}
else {
pug_html = pug_html + "\u003Cdiv class=\"button red\" id=\"sign\"\u003E进行中\u003C\u002Fdiv\u003E";
}
  break;
case 4:
if (signed) {
pug_html = pug_html + "\u003Cdiv class=\"button red disable\"\u003E已报名\u003C\u002Fdiv\u003E";
}
else {
pug_html = pug_html + "\u003Cdiv class=\"button red disable\"\u003E名额已满\u003C\u002Fdiv\u003E";
}
  break;
case 5:
pug_html = pug_html + "\u003Cdiv class=\"button red disable\"\u003E活动结束\u003C\u002Fdiv\u003E";
  break;
}
pug_html = pug_html + "\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cdiv class=\"detail-header\"\u003E活动内容\u003C\u002Fdiv\u003E\u003Cdiv class=\"detail\"\u003E" + (null == (pug_interp = detail) ? "" : pug_interp) + "\u003C\u002Fdiv\u003E";
if (share)
{
pug_html = pug_html + "\u003Cdiv class=\"share\"\u003E\u003Cdiv class=\"weixin\" title=\"分享到微信\"\u003E\u003Cdiv class=\"weixin-popup\"\u003E\u003Cdiv class=\"qrcode\"\u003E\u003C\u002Fdiv\u003E\u003Cdiv class=\"triangle\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Ca" + (" class=\"qzone\""+" target=\"_blank\" title=\"分享到 QQ 空间\""+pug_attr("href", "http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=" + encodeURIComponent(link) + "&title=" + encodeURIComponent(title) + "&desc=" + encodeURIComponent(title) + "&summary=&site=", true, false)) + "\u003E\u003C\u002Fa\u003E\u003Ca" + (" class=\"weibo\""+" target=\"_blank\" title=\"分享到新浪微博\""+pug_attr("href", "http://service.weibo.com/share/share.php?url=" + encodeURIComponent(link) + "&title=" + encodeURIComponent(title) + "&appkey=&searchPic=", true, false)) + "\u003E\u003C\u002Fa\u003E\u003Cdiv class=\"like normal\" data-type=\"1\" title=\"点赞\"\u003E\u003C\u002Fdiv\u003E\u003Cdiv class=\"favorite normal\" data-type=\"0\" title=\"收藏\"\u003E\u003C\u002Fdiv\u003E\u003Cdiv class=\"top\" title=\"返回顶部'\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E";
}
pug_html = pug_html + "\u003Cscript\u003E(function() {\n    var s  = document.createElement(\"link\");\n    s.type = \"text\u002Fcss\";\n    s.rel  = \"stylesheet\";\n    s.href = \"\u002Fwebrexco\u002Fstatic\u002Fcss\u002Fevents\u002Fdetail.css\";\n    document.getElementsByTagName(\"head\")[0].appendChild(s);\n})();\u003C\u002Fscript\u003E";}.call(this,"address" in locals_for_with?locals_for_with.address:typeof address!=="undefined"?address:undefined,"detail" in locals_for_with?locals_for_with.detail:typeof detail!=="undefined"?detail:undefined,"encodeURIComponent" in locals_for_with?locals_for_with.encodeURIComponent:typeof encodeURIComponent!=="undefined"?encodeURIComponent:undefined,"endTime" in locals_for_with?locals_for_with.endTime:typeof endTime!=="undefined"?endTime:undefined,"host" in locals_for_with?locals_for_with.host:typeof host!=="undefined"?host:undefined,"link" in locals_for_with?locals_for_with.link:typeof link!=="undefined"?link:undefined,"people" in locals_for_with?locals_for_with.people:typeof people!=="undefined"?people:undefined,"poster" in locals_for_with?locals_for_with.poster:typeof poster!=="undefined"?poster:undefined,"share" in locals_for_with?locals_for_with.share:typeof share!=="undefined"?share:undefined,"signed" in locals_for_with?locals_for_with.signed:typeof signed!=="undefined"?signed:undefined,"startTime" in locals_for_with?locals_for_with.startTime:typeof startTime!=="undefined"?startTime:undefined,"status" in locals_for_with?locals_for_with.status:typeof status!=="undefined"?status:undefined,"title" in locals_for_with?locals_for_with.title:typeof title!=="undefined"?title:undefined));;return pug_html;}
    </script>
    <script src="https://map.qq.com/api/js?v=2.exp"></script>
    <script>// Production steps of ECMA-262, Edition 5, 15.4.4.14
// Reference: http://es5.github.io/#x15.4.4.14
if (!Array.prototype.indexOf) {
    Array.prototype.indexOf = function (searchElement, fromIndex) {

        var k;

        // 1. Let o be the result of calling ToObject passing
        //    the this value as the argument.
        if (this == null) {
            throw new TypeError('"this" is null or not defined');
        }

        var o = Object(this);

        // 2. Let lenValue be the result of calling the Get
        //    internal method of o with the argument "length".
        // 3. Let len be ToUint32(lenValue).
        var len = o.length >>> 0;

        // 4. If len is 0, return -1.
        if (len === 0) {
            return -1;
        }

        // 5. If argument fromIndex was passed let n be
        //    ToInteger(fromIndex); else let n be 0.
        var n = fromIndex | 0;

        // 6. If n >= len, return -1.
        if (n >= len) {
            return -1;
        }

        // 7. If n >= 0, then Let k be n.
        // 8. Else, n<0, Let k be len - abs(n).
        //    If k is less than 0, then let k be 0.
        k = Math.max(n >= 0 ? n : len - Math.abs(n), 0);

        // 9. Repeat, while k < len
        while (k < len) {
            // a. Let Pk be ToString(k).
            //   This is implicit for LHS operands of the in operator
            // b. Let kPresent be the result of calling the
            //    HasProperty internal method of o with argument Pk.
            //   This step can be combined with c
            // c. If kPresent is true, then
            //    i.  Let elementK be the result of calling the Get
            //        internal method of o with the argument ToString(k).
            //   ii.  Let same be the result of applying the
            //        Strict Equality Comparison Algorithm to
            //        searchElement and elementK.
            //  iii.  If same is true, return k.
            if (k in o && o[k] === searchElement) {
                return k;
            }
            k++;
        }
        return -1;
    };
}

if (!Array.prototype.forEach) {
    Array.prototype.forEach = function (callback, thisArg) {
        var T, k;
        if (this === null) {
            throw new TypeError('this is null or not defined');
        }
        var O = Object(this);
        var len = O.length >>> 0;
        if (typeof callback !== 'function') {
            throw new TypeError(callback + ' is not a function');
        }
        if (arguments.length > 1) {
            T = thisArg;
        }
        k = 0;
        while (k < len) {
            var kValue;
            if (k in O) {
                kValue = O[k];
                callback.call(T, kValue, k, O);
            }
            k++;
        }
    };
}

if (!Date.now) {
    Date.now = function () {
        return new Date().valueOf();
    }
}

!window.addEventListener && (function (WindowPrototype, DocumentPrototype, ElementPrototype, addEventListener, removeEventListener, dispatchEvent, registry) {
    WindowPrototype[addEventListener] = DocumentPrototype[addEventListener] = ElementPrototype[addEventListener] = function (type, listener) {
        var target = this;

        registry.unshift([target, type, listener, function (event) {
            event.currentTarget = target;
            event.preventDefault = function () { event.returnValue = false };
            event.stopPropagation = function () { event.cancelBubble = true };
            event.target = event.srcElement || target;

            listener.call(target, event);
        }]);

        this.attachEvent("on" + type, registry[0][3]);
    };

    WindowPrototype[removeEventListener] = DocumentPrototype[removeEventListener] = ElementPrototype[removeEventListener] = function (type, listener) {
        for (var index = 0, register; register = registry[index]; ++index) {
            if (register[0] == this && register[1] == type && register[2] == listener) {
                return this.detachEvent("on" + type, registry.splice(index, 1)[0][3]);
            }
        }
    };

    WindowPrototype[dispatchEvent] = DocumentPrototype[dispatchEvent] = ElementPrototype[dispatchEvent] = function (eventObject) {
        return this.fireEvent("on" + eventObject.type, eventObject);
    };
})(Window.prototype, HTMLDocument.prototype, Element.prototype, "addEventListener", "removeEventListener", "dispatchEvent", []);

$("input[type=checkbox], input[type=radio]").change(function () {
    $("input[type=checkbox], input[type=radio]").each(function () {
        $(this).next().toggleClass("checked", this.checked);
    });
});

$("label").on("selectstart", false);
$('input, textarea').placeholder();

function map(title, city, address) {
    var map = new qq.maps.Map("map", {
        mapTypeControl: false,
        panControl: false,
        zoomControl: false,
        scaleControl: false,
    });

    geocoder = new qq.maps.Geocoder({
        complete: function (result) {
            var location = result.detail.location;

            var marker = new qq.maps.Marker({
                map: map,
                position: location
            });
            qq.maps.event.addListener(marker, 'click', function () {
                window.open("http://apis.map.qq.com/uri/v1/marker?marker=" + encodeURIComponent("coord:" + location.toString() + ";addr:" + address + ";title:" + title) + "&referer=aidai");
            });
            map.setCenter(location);
            map.zoomTo(17);
        },
    });
    geocoder.getLocation(city + address);
}

!function () {
    function query(name, url) {
        if (!url) {
            url = window.location.href;
        }
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    };

    var id = query("id");
    if (!id) {
        location.href = "/webrexco/404.htm";
        return;
    }

    $("#input-anonymous").click(function () {
        if (this.checked)
            $("#input-name").attr("placeholder", "").removeAttr("required").change();
        else
            $("#input-name").attr("placeholder", "必填").attr("required", "").change();
    });

    $("input, select, textarea").focus(function () {
        var $this = $(this);
        if (!$this.is("[required]"))
            return;

        var val = $this.val();
        if (val == null || $.trim(val) == "")
            $this.addClass("invalid");
    }).on("input change", function () {
        var $this = $(this);
        var val = $this.val();
        if ($this.is("[required]") &&
            (val == null || $.trim(val) == "")) {
            if ($this.is("select") || $this.is("[type=file]"))
                $this.data("error", "请选择" + $this.data("name"));
            else
                $this.data("error", "请填写" + $this.data("name"));
            $this.addClass("invalid");
            return;
        }

        var pattern = $this.attr("pattern");
        if (pattern && !val.match("^" + pattern + "$")) {
            $this.data("error", "请正确填写" + $this.data("name"));
            $this.addClass("invalid");
            return;
        }

        var maxlength = $this.attr("maxlength");
        if (maxlength && val.length > maxlength) {
            $this.data("error", $this.data("name") + "超出长度限制");
            $this.addClass("invalid");
            return;
        }

        var accept = $this.attr("accept");
        if (accept) {
            var list = accept.split(", ");
            var ext = $this.val();
            ext = ext.substr(ext.lastIndexOf("."));
            if (list.indexOf(ext) == -1) {
                $this.data("error", $this.data("name") + "的文件类型被禁止");
                $this.addClass("invalid");
                return;
            }
        }

        $this.removeClass("invalid");
    });

    $("#input-activity-id").val(id);

    $.ajax({
        url: "/webrexco/events/detail.cgi",
        method: "POST",
        timeout: 10000,
        data: { activityId: id },
        success: function (data) {
            if (data.code == 404) {
                location.href = "/webrexco/404.htm";
                return;
            }

            if (data.code != 0) {
                util.tipsModal(2, data.message);
                return;
            }

            var activity = data.activity;

            document.title = activity.name;
            $("#keywords, #description").attr("content", activity.name);

            $(".main").html(detail({
                poster: activity.posterUrl,
                title: activity.name,
                startTime: activity.startTime.substring(0, activity.startTime.length - 4),
                endTime: activity.endTime.substring(0, activity.endTime.length - 4),
                address: activity.province + activity.city + activity.address,
                people: "限额" + activity.partiNum + "人",
                host: activity.host + " 主办",
                detail: activity.content,
                share: true,
                link: location.href,
                signed: data.signed,
                status: activity.status
            }));

            map(activity.name, activity.city, activity.address);

            var link = window.location.href;
            var content = activity.name;
            $(".weixin").hover(function () {
                $(".weixin-popup").fadeIn();
            }, function () {
                $(".weixin-popup").fadeOut();
            });
            $('.qrcode').qrcode({
                // render 方式: 'canvas', 'image' or 'div'//用image适配方便
                render: 'image',
                // 容错等级: 'L', 'M', 'Q' or 'H'
                ecLevel: 'L',
                // 控制canvas 偏移
                left: 0,
                top: 0,
                // 控制二维码尺寸
                size: 84,
                // 控制二维码颜色
                fill: '#000',
                // background color or image element, null for transparent background
                background: null,
                // 二维码内容
                text: link,
                // 控制二维码的圆角: 0.0 .. 0.5
                radius: 0,
                // 边缘留空，默认0
                quiet: 0,
            });

            if (data.is_assist)
                $(".like").toggleClass("normal active");
            if (data.is_collection)
                $(".favorite").toggleClass("normal active");

            $(".like, .favorite").click(function () {
                var $this = $(this);
                $.ajax({
                    url: "/webrexco/events/like.cgi",
                    method: "POST",
                    timeout: 10000,
                    data: {
                        activityId: id,
                        type: $this.data("type")
                    },
                    success: function (data) {
                        if (data.code == 401) {
                            showIframe("/webrexco/activity/login/login.htm?refresh=1");
                            return;
                        }

                        if (data.code !== 0) {
                            util.tipsModal(2, data.message);
                            return;
                        }

                        $this.toggleClass("normal active");
                    },
                    error: function () {
                        util.tipsModal(2, "系统异常");
                    }
                });
            });

            $(".top, .u-toBodyTop").click(function () {
                $("html, body").stop().animate({ scrollTop: 0 }, '500', 'swing');
            });

            data.joinUser.forEach(function (item) {
                $(".swiper-wrapper").append($("<div>").addClass("swiper-slide item").append("日期：", $("<span>").addClass("time").text(item.createDate.substring(0, 10)), "用户：", $("<span>").addClass("user").text(item.realName)));
            });

            if (data.joinUser.length > 5) {

                var mySwiper = new Swiper('.swiper-container', {
                    direction: "vertical",
                    setWrapperSize: true,

                    height: 20 * 5,
                    spaceBetween: 0,
                    slidesPerView: 5,

                    simulateTouch: false,

                    loop: true,
                    autoplay: 3000,
                });
            }

            $("#sign").click(sign);

            $(".cancel, .close").click(function () {
                $(".mask").hide();
                $(document.body).removeClass("overlay");
            });

            $("#submit").click(function () {
                var $this = $(this);
                if ($this.hasClass("disabled"))
                    return;

                $("input, select, textarea").change();
                var invalid = $(".invalid");
                if (invalid.length) {
                    util.tipsModal(2, invalid.data("error"));
                    return;
                }

                $this.addClass("disabled").text("正在提交");

                $.ajax({
                    url: "/webrexco/events/signup.cgi",
                    method: "POST",
                    timeout: 10000,
                    data: $("form").serialize(),
                    success: function (data) {
                        if (data.code !== 0) {
                            util.tipsModal(2, data.message);
                            $this.removeClass("disabled").text("确 认");
                            return;
                        }

                        util.tipsModal(1, data.message, function () {
                            location.reload();
                        }, function () {
                            location.reload();
                        });
                        $(".mask").hide();
                        $(document.body).removeClass("overlay");
                    },
                    error: function () {
                        util.tipsModal(2, "系统异常");
                        $this.removeClass("disabled").text("确 认");
                    }
                });
            });
        },
        error: function () {
            util.tipsModal(2, "系统异常");
        }
    });
}();

function sign() {
    $.ajax({
        url: "/webrexco/events/info.cgi",
        method: "POST",
        timeout: 10000,
        success: function (data) {
            if (data.code == 401) {
                showIframe("/webrexco/activity/login/login.htm?refresh=1");
                return;
            }

            if (data.code !== 0) {
                util.tipsModal(2, data.message);
                return;
            }

            var info = data.info;
            if (info) {
                $("#input-name").val(info.realName);
                $("#input-company").val(info.company);
                $("#input-position").val(info.job);
                $("#input-phone").val(info.phone);
                $("#input-mail").val(info.email);
                $("#input-weixin").val(info.wechat);
            }

            $(".mask").show();
            $(document.body).addClass("overlay");
        },
        error: function () {
            util.tipsModal(2, "系统异常");
        }
    });
}

    </script>
  </body>
</html>